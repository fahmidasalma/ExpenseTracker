{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid mt-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-md-10">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a href="{% url 'expenses' %}">Dashboard</a>
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            Financial Analytics
          </li>
        </ol>
      </nav>
      <h2 class="mb-0">Financial Overview - Last 6 Months</h2>
    </div>
    <div class="col-md-2">
      <a href="{% url 'expenses' %}" class="btn btn-primary">Back to Expenses</a>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <h5 class="card-title">Total Expenses</h5>
          <h3 id="totalExpenses">{{ currency }} 0</h3>
          <p class="card-text">Last 6 months</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h5 class="card-title">Total Income</h5>
          <h3 id="totalIncome">{{ currency }} 0</h3>
          <p class="card-text">Last 6 months</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-info">
        <div class="card-body">
          <h5 class="card-title">Net Savings</h5>
          <h3 id="netSavings">{{ currency }} 0</h3>
          <p class="card-text" id="savingsRate">0% savings rate</p>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-white bg-warning">
        <div class="card-body">
          <h5 class="card-title">Avg Monthly</h5>
          <h3 id="avgMonthly">{{ currency }} 0</h3>
          <p class="card-text">Average expenses</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chart Navigation Tabs -->
  <ul class="nav nav-tabs mb-4" id="chartTabs" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="overview-tab" data-toggle="tab" href="#overview" role="tab">Monthly Overview</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="expenses-tab" data-toggle="tab" href="#expenses" role="tab">Expense Analysis</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="income-tab" data-toggle="tab" href="#income" role="tab">Income Analysis</a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="comparison-tab" data-toggle="tab" href="#comparison" role="tab">Trend Analysis</a>
    </li>
  </ul>

  <!-- Chart Containers -->
  <div class="tab-content" id="chartTabContent">
    <!-- Monthly Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
      <div class="row">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h5>Monthly Income vs Expenses</h5>
            </div>
            <div class="card-body">
              <canvas id="monthlyComparisonChart" height="100"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>Net Savings by Month</h5>
            </div>
            <div class="card-body">
              <canvas id="savingsChart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Expense Analysis Tab -->
    <div class="tab-pane fade" id="expenses" role="tabpanel">
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Expenses by Category</h5>
            </div>
            <div class="card-body">
              <canvas id="expenseCategoryChart" height="150"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Monthly Expense Trend</h5>
            </div>
            <div class="card-body">
              <canvas id="expenseTrendChart" height="150"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-4">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">
              <h5>Top Spending Days</h5>
            </div>
            <div class="card-body">
              <canvas id="dailySpendingChart" height="80"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Income Analysis Tab -->
    <div class="tab-pane fade" id="income" role="tabpanel">
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Income by Source</h5>
            </div>
            <div class="card-body">
              <canvas id="incomeSourceChart" height="150"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Monthly Income Trend</h5>
            </div>
            <div class="card-body">
              <canvas id="incomeTrendChart" height="150"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Trend Analysis Tab -->
    <div class="tab-pane fade" id="comparison" role="tabpanel">
      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">
              <h5>6-Month Financial Trend</h5>
            </div>
            <div class="card-body">
              <canvas id="trendAnalysisChart" height="100"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="row mt-4">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Expense Categories Breakdown</h5>
            </div>
            <div class="card-body">
              <canvas id="categoryBreakdownChart" height="150"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>Income Sources Breakdown</h5>
            </div>
            <div class="card-body">
              <canvas id="sourceBreakdownChart" height="150"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="text-center" style="display: none;">
    <div class="spinner-border" role="status">
      <span class="sr-only">Loading...</span>
    </div>
    <p>Loading financial data...</p>
  </div>
</div>

<!-- Enhanced Chart.js Configuration -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

<script>
// Global chart configuration
Chart.defaults.font.family = "'Segoe UI', 'Helvetica Neue', Arial, sans-serif";
Chart.defaults.font.size = 12;
Chart.defaults.responsive = true;
Chart.defaults.maintainAspectRatio = false;

// Color schemes
const colorSchemes = {
  primary: ['#007bff', '#6c757d', '#28a745', '#ffc107', '#dc3545', '#17a2b8', '#6f42c1', '#e83e8c'],
  gradients: {
    income: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    expense: 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
    savings: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)'
  }
};

// Chart instances
let charts = {};

// Currency from Django template
const currency = '{{ currency }}';

// Utility functions
function formatCurrency(amount) {
  return `${currency} ${parseFloat(amount).toLocaleString()}`;
}

function createGradient(ctx, colorStart, colorEnd) {
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, colorStart);
  gradient.addColorStop(1, colorEnd);
  return gradient;
}

// Initialize all charts
function initializeCharts() {
  // Show loading spinner
  document.getElementById('loadingSpinner').style.display = 'block';
  
  Promise.all([
  fetch('/expense_summary_data/').then(r => r.json()),
  fetch('/income_summary_data/').then(r => r.json()),
  fetch('/financial_overview/').then(r => r.json())
  ]).then(([expenseData, incomeData, overviewData]) => {
    // Hide loading spinner
    document.getElementById('loadingSpinner').style.display = 'none';
    
    // Update summary cards
    updateSummaryCards(expenseData, incomeData, overviewData);
    
    // Create all charts
    createMonthlyComparisonChart(overviewData);
    createSavingsChart(overviewData);
    createExpenseCategoryChart(expenseData);
    createExpenseTrendChart(expenseData);
    createIncomeTrendChart(incomeData);
    createIncomeSourceChart(incomeData);
    createTrendAnalysisChart(overviewData);
    createCategoryBreakdownChart(expenseData);
    createSourceBreakdownChart(incomeData);
    createDailySpendingChart(expenseData);
    
  }).catch(error => {
    console.error('Error loading data:', error);
    document.getElementById('loadingSpinner').innerHTML = '<p class="text-danger">Error loading data. Please refresh the page.</p>';
  });
}

function updateSummaryCards(expenseData, incomeData, overviewData) {
  document.getElementById('totalExpenses').textContent = formatCurrency(expenseData.stats.total_expenses);
  document.getElementById('totalIncome').textContent = formatCurrency(incomeData.stats.total_income);
  document.getElementById('netSavings').textContent = formatCurrency(overviewData.summary.net_savings);
  document.getElementById('avgMonthly').textContent = formatCurrency(expenseData.stats.avg_monthly);
  document.getElementById('savingsRate').textContent = `${overviewData.summary.savings_rate.toFixed(1)}% savings rate`;
}

function createMonthlyComparisonChart(overviewData) {
  const ctx = document.getElementById('monthlyComparisonChart').getContext('2d');
  const months = Object.keys(overviewData.monthly_comparison).reverse();
  const incomeData = months.map(month => overviewData.monthly_comparison[month].income);
  const expenseData = months.map(month => overviewData.monthly_comparison[month].expenses);
  
  charts.monthlyComparison = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: months,
      datasets: [{
        label: 'Income',
        data: incomeData,
        backgroundColor: createGradient(ctx, '#28a745', '#20c997'),
        borderColor: '#28a745',
        borderWidth: 2
      }, {
        label: 'Expenses',
        data: expenseData,
        backgroundColor: createGradient(ctx, '#dc3545', '#fd7e14'),
        borderColor: '#dc3545',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            }
          }
        }
      }
    }
  });
}

function createSavingsChart(overviewData) {
  const ctx = document.getElementById('savingsChart').getContext('2d');
  const months = Object.keys(overviewData.monthly_comparison).reverse();
  const savingsData = months.map(month => overviewData.monthly_comparison[month].net);
  
  charts.savings = new Chart(ctx, {
    type: 'line',
    data: {
      labels: months,
      datasets: [{
        label: 'Net Savings',
        data: savingsData,
        borderColor: '#17a2b8',
        backgroundColor: createGradient(ctx, 'rgba(23, 162, 184, 0.2)', 'rgba(23, 162, 184, 0.05)'),
        borderWidth: 3,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Savings: ' + formatCurrency(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            }
          }
        }
      }
    }
  });
}

function createExpenseCategoryChart(expenseData) {
  const ctx = document.getElementById('expenseCategoryChart').getContext('2d');
  const categories = Object.keys(expenseData.categories_data);
  const amounts = Object.values(expenseData.categories_data);
  
  charts.expenseCategory = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: categories,
      datasets: [{
        data: amounts,
        backgroundColor: colorSchemes.primary,
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed / total) * 100).toFixed(1);
              return context.label + ': ' + formatCurrency(context.parsed) + ` (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

function createExpenseTrendChart(expenseData) {
  const ctx = document.getElementById('expenseTrendChart').getContext('2d');
  const months = Object.keys(expenseData.monthly_totals).reverse();
  const amounts = months.map(month => expenseData.monthly_totals[month]);
  
  charts.expenseTrend = new Chart(ctx, {
    type: 'line',
    data: {
      labels: months,
      datasets: [{
        label: 'Monthly Expenses',
        data: amounts,
        borderColor: '#dc3545',
        backgroundColor: createGradient(ctx, 'rgba(220, 53, 69, 0.2)', 'rgba(220, 53, 69, 0.05)'),
        borderWidth: 3,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Expenses: ' + formatCurrency(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            }
          }
        }
      }
    }
  });
}

function createIncomeTrendChart(incomeData) {
  const ctx = document.getElementById('incomeTrendChart').getContext('2d');
  const months = Object.keys(incomeData.monthly_totals).reverse();
  const amounts = months.map(month => incomeData.monthly_totals[month]);
  
  charts.incomeTrend = new Chart(ctx, {
    type: 'line',
    data: {
      labels: months,
      datasets: [{
        label: 'Monthly Income',
        data: amounts,
        borderColor: '#28a745',
        backgroundColor: createGradient(ctx, 'rgba(40, 167, 69, 0.2)', 'rgba(40, 167, 69, 0.05)'),
        borderWidth: 3,
        fill: true,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Income: ' + formatCurrency(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            }
          }
        }
      }
    }
  });
}

function createIncomeSourceChart(incomeData) {
  const ctx = document.getElementById('incomeSourceChart').getContext('2d');
  const sources = Object.keys(incomeData.sources_data);
  const amounts = Object.values(incomeData.sources_data);
  
  charts.incomeSource = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: sources,
      datasets: [{
        data: amounts,
        backgroundColor: colorSchemes.primary,
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const total = context.dataset.data.reduce((a, b) => a + b, 0);
              const percentage = ((context.parsed / total) * 100).toFixed(1);
              return context.label + ': ' + formatCurrency(context.parsed) + ` (${percentage}%)`;
            }
          }
        }
      }
    }
  });
}

function createTrendAnalysisChart(overviewData) {
  const ctx = document.getElementById('trendAnalysisChart').getContext('2d');
  const months = Object.keys(overviewData.monthly_comparison).reverse();
  const incomeData = months.map(month => overviewData.monthly_comparison[month].income);
  const expenseData = months.map(month => overviewData.monthly_comparison[month].expenses);
  const netData = months.map(month => overviewData.monthly_comparison[month].net);
  
  charts.trendAnalysis = new Chart(ctx, {
    type: 'line',
    data: {
      labels: months,
      datasets: [{
        label: 'Income',
        data: incomeData,
        borderColor: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.1)',
        borderWidth: 3,
        fill: false,
        tension: 0.4
      }, {
        label: 'Expenses',
        data: expenseData,
        borderColor: '#dc3545',
        backgroundColor: 'rgba(220, 53, 69, 0.1)',
        borderWidth: 3,
        fill: false,
        tension: 0.4
      }, {
        label: 'Net Savings',
        data: netData,
        borderColor: '#17a2b8',
        backgroundColor: 'rgba(23, 162, 184, 0.1)',
        borderWidth: 3,
        fill: false,
        tension: 0.4
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: false,
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            }
          }
        }
      }
    }
  });
}

function createCategoryBreakdownChart(expenseData) {
  const ctx = document.getElementById('categoryBreakdownChart').getContext('2d');
  const categories = Object.keys(expenseData.categories_data);
  const amounts = Object.values(expenseData.categories_data);
  
  charts.categoryBreakdown = new Chart(ctx, {
    type: 'polarArea',
    data: {
      labels: categories,
      datasets: [{
        data: amounts,
        backgroundColor: colorSchemes.primary.map(color => color + '80'),
        borderColor: colorSchemes.primary,
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'bottom',
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.label + ': ' + formatCurrency(context.parsed.r);
            }
          }
        }
      }
    }
  });
}

function createSourceBreakdownChart(incomeData) {
  const ctx = document.getElementById('sourceBreakdownChart').getContext('2d');
  const sources = Object.keys(incomeData.sources_data);
  const amounts = Object.values(incomeData.sources_data);
  
  charts.sourceBreakdown = new Chart(ctx, {
    type: 'radar',
    data: {
      labels: sources,
      datasets: [{
        label: 'Income Sources',
        data: amounts,
        borderColor: '#28a745',
        backgroundColor: 'rgba(40, 167, 69, 0.2)',
        borderWidth: 2,
        pointBackgroundColor: '#28a745',
        pointBorderColor: '#fff',
        pointBorderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return context.label + ': ' + formatCurrency(context.parsed.r);
            }
          }
        }
      },
      scales: {
        r: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            }
          }
        }
      }
    }
  });
}

function createDailySpendingChart(expenseData) {
  const ctx = document.getElementById('dailySpendingChart').getContext('2d');
  const dailyData = expenseData.daily_spending.slice(0, 10); // Top 10 days
  const dates = dailyData.map(item => new Date(item.date).toLocaleDateString());
  const amounts = dailyData.map(item => item.total);
  
  charts.dailySpending = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: dates,
      datasets: [{
        label: 'Daily Spending',
        data: amounts,
        backgroundColor: createGradient(ctx, '#fd7e14', '#ffc107'),
        borderColor: '#fd7e14',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Spent: ' + formatCurrency(context.parsed.y);
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            }
          }
        }
      }
    }
  });
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', function() {
  initializeCharts();
});

// Handle tab changes
document.querySelectorAll('[data-toggle="tab"]').forEach(tab => {
  tab.addEventListener('shown.bs.tab', function (e) {
    // Resize charts when tab becomes visible
    Object.values(charts).forEach(chart => {
      if (chart) {
        chart.resize();
      }
    });
  });
});
</script>

<style>
.card {
  box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
  border: 1px solid rgba(0, 0, 0, 0.125);
  border-radius: 0.375rem;
  margin-bottom: 1rem;
}

.card-header {
  background-color: #f8f9fa;
  border-bottom: 1px solid rgba(0, 0, 0, 0.125);
  font-weight: 600;
}

.nav-tabs .nav-link.active {
  background-color: #007bff;
  color: white;
  border-color: #007bff;
}

.bg-primary {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
}

.bg-success {
  background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
}

.bg-info {
  background: linear-gradient(135deg, #17a2b8 0%, #138496 100%) !important;
}

.bg-warning {
  background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%) !important;
}

.spinner-border {
  width: 3rem;
  height: 3rem;
}

@media (max-width: 768px) {
  .card-body canvas {
    height: 250px !important;
  }
}
</style>

{% endblock content %}